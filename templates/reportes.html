<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes - CuzoNet Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="bg-animation">
        <div class="bg-gradient"></div>
        <div class="bg-grid"></div>
    </div>

    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-network-wired"></i>
                <span>CuzoNet</span>
            </div>
            <p class="logo-subtitle">MikroTik Manager</p>
        </div>

        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/clientes" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/pagos" class="nav-link">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Pagos</span>
                </a>
            </li>
            <li class="nav-item active">
                <a href="/reportes" class="nav-link">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reportes</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/configuracion" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span>Configuracion</span>
                </a>
            </li>
            <li class="nav-item"><a href="/mapa" class="nav-link"><i class="fas fa-map-marked-alt"></i><span>Mapa</span></a></li>
            <li class="nav-item"><a href="/monitor" class="nav-link"><i class="fas fa-tachometer-alt"></i><span>Monitor</span></a></li>
            <li class="nav-item"><a href="/actividad" class="nav-link"><i class="fas fa-history"></i><span>Actividad</span></a></li>
        </ul>

        <div class="sidebar-footer">
            <div class="theme-toggle" onclick="toggleTheme()" style="display:flex;align-items:center;gap:10px;padding:10px 16px;cursor:pointer;color:var(--text-secondary);border-radius:var(--radius-md);transition:all .2s;" onmouseover="this.style.background='rgba(14,165,233,0.1)'" onmouseout="this.style.background='transparent'">
                <i class="fas fa-moon" id="themeIcon"></i>
                <span id="themeText">Modo Claro</span>
            </div>
            <div class="mikrotik-status" id="mikrotikStatus">
                <div class="status-indicator offline"></div>
                <span>MikroTik: Verificando...</span>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <header class="header">
            <div class="header-left">
                <h1>Reportes y Estadisticas</h1>
                <p class="header-subtitle">Visualiza el estado de tu negocio</p>
            </div>
            <div class="header-right">
                <button class="btn btn-secondary" onclick="window.open('/api/clientes/exportar')">
                    <i class="fas fa-download"></i> Exportar Excel
                </button>
            </div>
        </header>

        <!-- Stats Cards - Clientes -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue"><i class="fas fa-users"></i></div>
                <div class="stat-info">
                    <h3 id="totalClientes">0</h3>
                    <p>Total Clientes</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green"><i class="fas fa-user-check"></i></div>
                <div class="stat-info">
                    <h3 id="clientesActivos">0</h3>
                    <p>Activos</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon yellow"><i class="fas fa-user-clock"></i></div>
                <div class="stat-info">
                    <h3 id="clientesSuspendidos">0</h3>
                    <p>Suspendidos</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red"><i class="fas fa-user-slash"></i></div>
                <div class="stat-info">
                    <h3 id="clientesCortados">0</h3>
                    <p>Cortados</p>
                </div>
            </div>
        </section>

        <!-- Stats Cards - Ingresos -->
        <section class="stats-grid" style="margin-top: 20px;">
            <div class="stat-card income-card">
                <div class="stat-icon green"><i class="fas fa-coins"></i></div>
                <div class="stat-info">
                    <h3 id="recaudadoMes">Q0.00</h3>
                    <p>Recaudado este mes</p>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressRecaudado" style="width: 0%"></div>
                        </div>
                        <span class="progress-text" id="porcentajeRecaudado">0%</span>
                    </div>
                </div>
            </div>
            <div class="stat-card income-card">
                <div class="stat-icon purple"><i class="fas fa-chart-line"></i></div>
                <div class="stat-info">
                    <h3 id="proyeccionMensual">Q0.00</h3>
                    <p>Ingreso mensual esperado</p>
                    <small class="stat-hint">Basado en precios de planes</small>
                </div>
            </div>
        </section>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-pie"></i> Distribucion de Clientes por Plan</h3>
                </div>
                <div class="chart-body">
                    <canvas id="chartPlanes"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-bar"></i> Ingresos Mensuales</h3>
                </div>
                <div class="chart-body">
                    <canvas id="chartPagos"></canvas>
                </div>
            </div>
        </div>

        <!-- Table -->
        <section class="table-section" style="margin-top: 30px;">
            <div class="table-header">
                <h2><i class="fas fa-list-alt"></i> Desglose por Plan</h2>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Plan</th>
                            <th>Clientes</th>
                            <th>Porcentaje</th>
                            <th>Ingreso Esperado</th>
                        </tr>
                    </thead>
                    <tbody id="tablePlanes"></tbody>
                </table>
            </div>
        </section>
    </main>

    <div class="toast-container" id="toastContainer"></div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        let chartPlanes = null;
        let chartPagos = null;

        async function cargarReportes() {
            try {
                const res = await fetch('/api/reportes/resumen');
                const data = await res.json();

                if (data.success) {
                    const d = data.data;

                    // Actualizar estadÃ­sticas
                    document.getElementById('totalClientes').textContent = d.total_clientes;
                    document.getElementById('clientesActivos').textContent = d.clientes_activos;
                    document.getElementById('clientesSuspendidos').textContent = d.clientes_suspendidos;
                    document.getElementById('clientesCortados').textContent = d.clientes_cortados;
                    document.getElementById('recaudadoMes').textContent = 'Q' + d.total_recaudado_mes.toFixed(2);
                    document.getElementById('proyeccionMensual').textContent = 'Q' + d.total_mensual_esperado.toFixed(2);

                    // Actualizar barra de progreso
                    const porcentaje = Math.min(d.porcentaje_recaudado, 100);
                    document.getElementById('progressRecaudado').style.width = porcentaje + '%';
                    document.getElementById('porcentajeRecaudado').textContent = porcentaje.toFixed(0) + '%';

                    // Renderizar grÃ¡ficos
                    renderChartPlanes(d.clientes_por_plan);
                    renderTablaPlanes(d.clientes_por_plan, d.total_clientes);
                }

                // Cargar pagos mensuales
                const pagosRes = await fetch('/api/reportes/pagos-mensuales');
                const pagos = await pagosRes.json();
                if (pagos.success) {
                    renderChartPagos(pagos.data);
                }
            } catch (e) {
                console.error('Error cargando reportes:', e);
            }
        }

        function renderChartPlanes(datos) {
            const ctx = document.getElementById('chartPlanes').getContext('2d');
            const labels = datos.map(d => d.plan || 'Sin plan');
            const values = datos.map(d => d.cantidad);
            const colors = [
                '#0ea5e9', '#06b6d4', '#f093fb', '#f5576c',
                '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
            ];

            if (chartPlanes) chartPlanes.destroy();

            chartPlanes = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                padding: 15,
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
        }

        function renderChartPagos(datos) {
            const ctx = document.getElementById('chartPagos').getContext('2d');

            // Ordenar por mes
            datos.sort((a, b) => a.mes.localeCompare(b.mes));

            const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const labels = datos.map(d => {
                const [year, month] = d.mes.split('-');
                return meses[parseInt(month) - 1] + ' ' + year;
            });
            const values = datos.map(d => d.total);

            if (chartPagos) chartPagos.destroy();

            chartPagos = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Recaudado (Q)',
                        data: values,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#0ea5e9',
                        borderWidth: 1,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#888' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    }
                }
            });
        }

        function renderTablaPlanes(datos, total) {
            const tbody = document.getElementById('tablePlanes');
            tbody.innerHTML = '';

            if (datos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state"><i class="fas fa-chart-pie"></i><p>No hay datos disponibles</p></td></tr>';
                return;
            }

            datos.forEach(item => {
                const porcentaje = total > 0 ? (item.cantidad / total * 100).toFixed(1) : 0;
                const ingresoEsperado = (item.cantidad * (item.precio || 0)).toFixed(2);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${item.plan || 'Sin plan'}</strong></td>
                    <td>${item.cantidad}</td>
                    <td>
                        <div class="progress-inline">
                            <div class="progress-bar-small">
                                <div class="progress-fill" style="width: ${porcentaje}%"></div>
                            </div>
                            <span>${porcentaje}%</span>
                        </div>
                    </td>
                    <td><strong class="text-success">Q${ingresoEsperado}</strong></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function () {
            cargarReportes();
            checkMikroTikStatus();
        });
    </script>

    <style>
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .chart-card {
            background: rgba(30, 30, 50, 0.8);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .chart-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-header h3 {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
        }

        .chart-header h3 i {
            margin-right: 10px;
            color: #0ea5e9;
        }

        .chart-body {
            padding: 20px;
            height: 320px;
        }

        .income-card {
            flex: 1;
        }

        .income-card .stat-info {
            flex: 1;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0ea5e9, #06b6d4);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-text {
            color: #0ea5e9;
            font-weight: 600;
            font-size: 14px;
            min-width: 45px;
        }

        .stat-hint {
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }

        .progress-inline {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar-small {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-small .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0ea5e9, #06b6d4);
        }

        .text-success {
            color: #43e97b;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-body {
                height: 250px;
            }
        }
    </style>
</body>

</html>
