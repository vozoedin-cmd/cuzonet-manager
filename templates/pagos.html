<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagos - CuzoNet Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="bg-animation">
        <div class="bg-gradient"></div>
        <div class="bg-grid"></div>
    </div>

    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-network-wired"></i>
                <span>CuzoNet</span>
            </div>
            <p class="logo-subtitle">MikroTik Manager</p>
        </div>

        <ul class="nav-menu">
            <li class="nav-item">
                <a href="/" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/clientes" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span>Clientes</span>
                </a>
            </li>
            <li class="nav-item active">
                <a href="/pagos" class="nav-link">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Pagos</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/reportes" class="nav-link">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reportes</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="/configuracion" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span>Configuracion</span>
                </a>
            </li>
            <li class="nav-item"><a href="/mapa" class="nav-link"><i class="fas fa-map-marked-alt"></i><span>Mapa</span></a></li>
            <li class="nav-item"><a href="/monitor" class="nav-link"><i class="fas fa-tachometer-alt"></i><span>Monitor</span></a></li>
            <li class="nav-item"><a href="/actividad" class="nav-link"><i class="fas fa-history"></i><span>Actividad</span></a></li>
        </ul>

        <div class="sidebar-footer">
            <div class="theme-toggle" onclick="toggleTheme()" style="display:flex;align-items:center;gap:10px;padding:10px 16px;cursor:pointer;color:var(--text-secondary);border-radius:var(--radius-md);transition:all .2s;" onmouseover="this.style.background='rgba(14,165,233,0.1)'" onmouseout="this.style.background='transparent'">
                <i class="fas fa-moon" id="themeIcon"></i>
                <span id="themeText">Modo Claro</span>
            </div>
            <div class="mikrotik-status" id="mikrotikStatus">
                <div class="status-indicator offline"></div>
                <span>MikroTik: Verificando...</span>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <header class="header">
            <div class="header-left">
                <h1>Gestion de Pagos</h1>
                <p class="header-subtitle">Registra y administra los pagos de tus clientes</p>
            </div>
            <div class="header-right">
                <button class="btn btn-secondary" onclick="openRecibosModal()">
                    <i class="fas fa-print"></i> Generar Recibos
                </button>
                <button class="btn btn-primary" onclick="openPagoModal()">
                    <i class="fas fa-plus"></i> Registrar Pago
                </button>
            </div>
        </header>

        <!-- Stats Cards -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon green"><i class="fas fa-dollar-sign"></i></div>
                <div class="stat-info">
                    <h3 id="totalRecaudado">Q0.00</h3>
                    <p>Recaudado este mes</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon blue"><i class="fas fa-receipt"></i></div>
                <div class="stat-info">
                    <h3 id="totalPagos">{{ pagos|length }}</h3>
                    <p>Pagos registrados</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon yellow"><i class="fas fa-clock"></i></div>
                <div class="stat-info">
                    <h3 id="pendientes">0</h3>
                    <p>Clientes por pagar</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon purple"><i class="fas fa-percentage"></i></div>
                <div class="stat-info">
                    <h3 id="porcentajeRecaudado">0%</h3>
                    <p>Meta mensual</p>
                </div>
            </div>
        </section>

        <!-- Actions -->
        <section class="table-section">
            <div class="table-header">
                <h2>Historial de Pagos</h2>
                <div class="table-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchPago" placeholder="Buscar pago..." onkeyup="filtrarPagos()">
                    </div>
                    <select id="filterMes" onchange="filtrarPagos()">
                        <option value="">Todos los meses</option>
                    </select>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table" id="pagosTable">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Monto</th>
                            <th>Mes</th>
                            <th>Metodo</th>
                            <th>Referencia</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="pagosTableBody">
                        {% for pago in pagos %}
                        <tr>
                            <td>{{ pago.fecha_pago.strftime('%Y-%m-%d %H:%M') if pago.fecha_pago else '-' }}</td>
                            <td>
                                <div class="client-info">
                                    <div class="client-avatar">{{ pago.cliente.nombre[0].upper() if pago.cliente else
                                        'N' }}</div>
                                    <span class="client-name">{{ pago.cliente.nombre if pago.cliente else 'N/A'
                                        }}</span>
                                </div>
                            </td>
                            <td><strong class="text-success">Q{{ "%.2f"|format(pago.monto) }}</strong></td>
                            <td><span class="badge">{{ pago.mes_correspondiente }}</span></td>
                            <td>
                                <span class="status-badge active">{{ pago.metodo_pago }}</span>
                            </td>
                            <td>{{ pago.referencia or '-' }}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-icon success" onclick="verRecibo({{ pago.id }})"
                                        title="Ver recibo">
                                        <i class="fas fa-file-invoice"></i>
                                    </button>
                                    <button class="btn-icon danger" onclick="eliminarPago({{ pago.id }})"
                                        title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}

                        {% if not pagos %}
                        <tr>
                            <td colspan="7" class="empty-state">
                                <i class="fas fa-receipt"></i>
                                <p>No hay pagos registrados</p>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Modal Registrar Pago -->
    <div class="modal-overlay" id="pagoModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-money-bill-wave"></i> Registrar Pago</h2>
                <button class="modal-close" onclick="closeModal('pagoModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="pagoForm" class="modal-form">
                <div class="form-group">
                    <label for="cliente_id"><i class="fas fa-user"></i> Cliente *</label>
                    <select id="cliente_id" name="cliente_id" required>
                        <option value="">Seleccionar cliente...</option>
                        {% for cliente in clientes %}
                        <option value="{{ cliente.id }}" data-precio="{{ cliente.precio_mensual }}">
                            {{ cliente.nombre }} - {{ cliente.ip_address }} (Q{{ "%.2f"|format(cliente.precio_mensual)
                            }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="monto"><i class="fas fa-quetzal-sign"></i> Monto (Q) *</label>
                        <input type="number" id="monto" name="monto" step="0.01" min="0" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="mes_correspondiente"><i class="fas fa-calendar"></i> Mes correspondiente</label>
                        <input type="month" id="mes_correspondiente" name="mes_correspondiente">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="metodo_pago"><i class="fas fa-credit-card"></i> Metodo de pago</label>
                        <select id="metodo_pago" name="metodo_pago">
                            <option value="efectivo">Efectivo</option>
                            <option value="transferencia">Transferencia</option>
                            <option value="deposito">Deposito</option>
                            <option value="tarjeta">Tarjeta</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="referencia"><i class="fas fa-hashtag"></i> Referencia</label>
                        <input type="text" id="referencia" name="referencia" placeholder="# de comprobante">
                    </div>
                </div>

                <div class="form-group">
                    <label for="notas"><i class="fas fa-sticky-note"></i> Notas</label>
                    <textarea id="notas" name="notas" rows="2" placeholder="Notas adicionales..."></textarea>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="activar_automatico" name="activar_automatico" checked>
                        <span>Activar cliente automaticamente si esta suspendido/cortado</span>
                    </label>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('pagoModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Registrar Pago
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Generar Recibos -->
    <div class="modal-overlay" id="recibosModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2><i class="fas fa-print"></i> Generar Recibos</h2>
                <button class="modal-close" onclick="closeModal('recibosModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-form">
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Selecciona un mes para generar todos los recibos e imprimirlos para entregar a tus clientes.
                </p>

                <div class="form-group">
                    <label for="mesRecibos"><i class="fas fa-calendar-alt"></i> Mes</label>
                    <input type="month" id="mesRecibos" class="form-control">
                </div>

                <div id="mesesDisponibles" style="margin-top: 15px;">
                    <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">Meses con pagos:</p>
                    <div id="listaMeses" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                </div>

                <div class="form-actions" style="margin-top: 25px;">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('recibosModal')">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="generarRecibos()">
                        <i class="fas fa-print"></i> Generar e Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // Cargar estadisticas
        async function cargarEstadisticas() {
            try {
                const response = await fetch('/api/reportes/resumen');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('totalRecaudado').textContent = `Q${data.data.total_recaudado_mes.toFixed(2)}`;
                    document.getElementById('porcentajeRecaudado').textContent = `${data.data.porcentaje_recaudado.toFixed(0)}%`;
                }
            } catch (error) {
                console.error('Error cargando estadisticas:', error);
            }
        }

        // Modal pago
        function openPagoModal() {
            openModal('pagoModal');
            document.getElementById('mes_correspondiente').value = new Date().toISOString().slice(0, 7);
        }

        // Modal recibos
        async function openRecibosModal() {
            openModal('recibosModal');
            document.getElementById('mesRecibos').value = new Date().toISOString().slice(0, 7);

            // Cargar meses disponibles
            try {
                const response = await fetch('/api/recibos/meses');
                const data = await response.json();

                if (data.success && data.meses.length > 0) {
                    const container = document.getElementById('listaMeses');
                    container.innerHTML = '';

                    const mesesNombres = {
                        '01': 'Ene', '02': 'Feb', '03': 'Mar', '04': 'Abr',
                        '05': 'May', '06': 'Jun', '07': 'Jul', '08': 'Ago',
                        '09': 'Sep', '10': 'Oct', '11': 'Nov', '12': 'Dic'
                    };

                    data.meses.slice(0, 6).forEach(mes => {
                        const [anio, mesNum] = mes.split('-');
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-sm btn-secondary';
                        btn.style.padding = '6px 12px';
                        btn.style.fontSize = '12px';
                        btn.textContent = `${mesesNombres[mesNum] || mesNum} ${anio}`;
                        btn.onclick = () => {
                            document.getElementById('mesRecibos').value = mes;
                        };
                        container.appendChild(btn);
                    });
                } else {
                    document.getElementById('mesesDisponibles').style.display = 'none';
                }
            } catch (error) {
                console.error('Error cargando meses:', error);
            }
        }

        // Generar recibos
        function generarRecibos() {
            const mes = document.getElementById('mesRecibos').value;
            if (!mes) {
                showToast('Selecciona un mes', 'warning');
                return;
            }

            // Abrir en nueva ventana
            window.open(`/recibos/mes/${mes}`, '_blank');
            closeModal('recibosModal');
        }

        // Auto-llenar monto al seleccionar cliente
        document.getElementById('cliente_id').addEventListener('change', function () {
            const option = this.options[this.selectedIndex];
            const precio = option.dataset.precio;
            if (precio && precio !== '0') {
                document.getElementById('monto').value = precio;
            }
        });

        // Registrar pago
        document.getElementById('pagoForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = {
                cliente_id: document.getElementById('cliente_id').value,
                monto: document.getElementById('monto').value,
                mes_correspondiente: document.getElementById('mes_correspondiente').value,
                metodo_pago: document.getElementById('metodo_pago').value,
                referencia: document.getElementById('referencia').value,
                notas: document.getElementById('notas').value,
                activar_automatico: document.getElementById('activar_automatico').checked
            };

            try {
                const response = await fetch('/api/pago', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Pago registrado exitosamente', 'success');
                    closeModal('pagoModal');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.error || 'Error al registrar pago', 'error');
                }
            } catch (error) {
                showToast('Error de conexion', 'error');
            }
        });

        // Ver recibo
        function verRecibo(pagoId) {
            window.open(`/api/recibo/${pagoId}`, '_blank');
        }

        // Filtrar pagos
        function filtrarPagos() {
            const search = document.getElementById('searchPago').value.toLowerCase();
            const rows = document.querySelectorAll('#pagosTableBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Eliminar pago
        async function eliminarPago(pagoId) {
            if (!confirm('¿Está seguro de eliminar este pago?')) return;

            try {
                const response = await fetch(`/api/pago/${pagoId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Pago eliminado exitosamente', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.error || 'Error al eliminar pago', 'error');
                }
            } catch (error) {
                showToast('Error de conexion', 'error');
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function () {
            cargarEstadisticas();
            checkMikroTikStatus();
        });
    </script>
</body>

</html>